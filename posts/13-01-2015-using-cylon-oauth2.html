<html>
    <head>
        <meta charset="utf-8"/>
        <title>: on the clojure move: Integrate juxt/cylon Oauth2 :</title>
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
        <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.1/styles/default.min.css">
        <link href="../css/screen.css" rel="stylesheet" type="text/css" />
        <link href="../css/bootswatch.css" rel="stylesheet" type="text/css" />
    </head>
    <body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>
            <!-- nav links -->
            <!--/.nav-collapse -->
        </div>

<div class="container">

            <!-- nav links -->

            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li ><a href="/index.html">on the clojure move</a></li>
                    <li ><a href="/archives.html">archives</a></li>
                    
                    <li >
                        <a href="/pages/about.html">@tangrammer</a>
                    </li>
                    
                    <li><a href="/feed.xml">rss</a></li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </nav>

    <div id="wrapper" class="container">
        <div class="row">
            <div class="col-md-11">
                <div id="content">
                
<div id="post">
        <div id="post-header">
        <h2>Integrate juxt/cylon Oauth2</h2>
        <div id="post-meta">
            
            <div class="date">January 13, 2015</div>
        </div>
    </div>
    <div>
        <ol class="contents"><li><a href="#let&apos;s_take_a_look_at_this_demo_system">Let's take a look at this demo system</a></li><li><a href="#generate_your_bootstrap-cover_system">Generate your bootstrap-cover system</a></li><li><a href="#add_oauth2_components">Add Oauth2 components</a></li><li><a href="#now,_let&apos;s_simplify">Now, let's simplify</a></li><li><a href="#todo:_full_doc_in_progress">TODO: full doc In progress</a></li></ol>
        <p>A couple of months before, <a href='https://github.com/juxt/cylon'>juxt/cylon</a> added Oauth2 client and provider functionality using a <a href='https://github.com/juxt/modular'>modular</a> approach. This post, using an example integration <a href='https://github.com/tangrammer/modular-cylon-example'>project</a>, tries to explain the implementation design details and the easy way to integrate cylon Oauth2 in your component project.  </p><h4><a name="how&#95;was&#95;this&#95;<a&#95;href='https://github.com/tangrammer/modular-cylon-example'>modular-cylon-example</a>&#95;project&#95;made?"></a>how was this <a href='https://github.com/tangrammer/modular-cylon-example'>modular-cylon-example</a> project made?</h4>I'd like to clear that this project has been generated using the modular template <code>bootstrap-cover</code> following instructions that you can find on <a href='http://modularity.org/'>modularity.org</a>. On top of this code I only translate the minimum needed code (mostly authored by <a href='https://github.com/malcolmsparks'>Malcolm Sparks</a>) to get working juxt/cylon oauth2 extension.  <h2><a name="let's&#95;take&#95;a&#95;look&#95;at&#95;this&#95;demo&#95;system"></a>Let's take a look at this demo system</h2><p>Althouh I've followed closely this <a href='https://tools.ietf.org/html/rfc6749'>Oauth2</a> implementation, I usually need to visualise the system to think about it, and also in this case I'll show you the system for better understanding</p><h3><a name="generate&#95;your&#95;bootstrap-cover&#95;system"></a>Generate your bootstrap-cover system</h3>Here you go the result of: <code>$ lein new modular foo bootstrap-cover</code> <p><a href='https://dl.dropboxusercontent.com/u/8688858/cylon-oauth2-example/bootstrap-cover.png'><img src="https://dl.dropboxusercontent.com/u/8688858/cylon-oauth2-example/bootstrap-cover.png" alt="Drawing" style="width: 100%;"/></a></p><p>As you can see bootstrap-cover template, provides you with one http-listener (modular.http-kit/Webserver) and four webservices (modular.bidi/WebService), all of them are instances of modular.bidi/StaticResourceService (to provide jquery, bootstrap and public resources) except :bootstrap-cover-website-website that makes the dynamic website responses.<br /> Note that although :modular-bidi-router-webrouter implements WebService too, is modular.ring/WebRequestHandler protocol the requirement for http-listener-listener to use it, so <a href='https://groups.google.com/forum/#!topic/clojure/YP&#95;VM6Zf4RQ'>"... the idea here is that you want individual components to be able to 'contribute' groups of routes"</a>.</p><h3><a name="add&#95;oauth2&#95;components"></a>Add Oauth2 components</h3>Here, I added the juxt/cylon components that implements Oauth2 to provide <a href='https://github.com/tangrammer/modular-cylon-example/blob/master/src/modular/cylon&#95;oauth&#95;example/system.clj#L143'>Authorization-Server</a> and <a href='https://github.com/tangrammer/modular-cylon-example/blob/master/src/modular/cylon&#95;oauth&#95;example/system.clj#L277'>Client</a> roles.<p>**Note that this demo, trying to be simple, uses an atom backed store not intended to be used in production environments (you'd loose all your persistent data each time your app restarts). You can replace that persistence implementation by any one persistence implementations you prefer (for example postgre), only you'll have to implements the require cylon protocol.</p><p>You can see last components plus 22 more :) . Don't be afraid I'll work a bit on getting clear this first diagram</p><p><a href='https://dl.dropboxusercontent.com/u/8688858/cylon-oauth2-example/all.png'><img src="https://dl.dropboxusercontent.com/u/8688858/cylon-oauth2-example/all.png" alt="Drawing" style="width: 100%;"/></a></p><h3><a name="now,&#95;let's&#95;simplify"></a>Now, let's simplify</h3>As I suspect that you're thinking now that OAuth2 is really complex now :), let's split a bit this complex diagram making simplifications to get the simplicity of OAuth2 specification<h4><a name="juxt/cylon&#95;persistence:&#95;&#95;tokenstore&#95;and&#95;sessionstore&#95;protocols"></a>juxt/cylon persistence:  TokenStore and SessionStore protocols</h4><p>As you can see in the system diagram there're a lot of session-store and token-store components, and obviuosly related with storing data. Following the protocols descriptions:</p><p><strong>cylon.token-store.protocols/<a href='https://github.com/juxt/cylon/blob/master/src/cylon/token&#95;store/protocols.clj#L11'>TokenStore</a></strong></p><blockquote><p> All TokenStore implementations must provide temporary or persistent   storage and must expire tokens that are no longer valid. Expiry   policies are left to the implementor to decide. Token ids are   determined by the client, but are recommended to be resistent to   prediction and thus forgery (using HMAC, etc.). </p></blockquote><p><strong>cylon.session.protocols/<a href='https://github.com/juxt/cylon/blob/master/src/cylon/session/protocols.clj#L3'>SessionStore</a></strong></p><blockquote><p> A SessionStore maps an identifier, stored in a cookie, to a set of   attributes. It is able to get cookies from the HTTP request, and set   them on the HTTP response. A SessionStore will typically wrap a   TokenStore. </p></blockquote><p>Due that all session-store need a token-store to maintain the related data, let's remove from our graph all those obvius token-store components (highlighted in orange). And the same with listener and router components (hightlighted in yellow)</p><p><a href='https://dl.dropboxusercontent.com/u/8688858/cylon-oauth2-example/first-step.png'><img src="https://dl.dropboxusercontent.com/u/8688858/cylon-oauth2-example/first-step.png" alt="Drawing" width="100%"/></a> <br><br><br><hr><br><br><br></p><p>Now, why don't we remove public static resource services (in yellow) and the clostache-templater (in orange)? ... they actually don't have any relation with Oauth2 <a href='https://dl.dropboxusercontent.com/u/8688858/cylon-oauth2-example/second-step.png'><img src="https://dl.dropboxusercontent.com/u/8688858/cylon-oauth2-example/second-step.png" alt="Drawing" style="width: 100%;"/></a> <br><br><br><hr><br><br><br></p><p>And, one pass more to take away the routers but highlighting only web services, authorization-server web-services in yellow, and web-server web-services in orange. </p><p><a href='https://dl.dropboxusercontent.com/u/8688858/cylon-oauth2-example/third-step.png'><img src="https://dl.dropboxusercontent.com/u/8688858/cylon-oauth2-example/third-step.png" alt="Drawing" style="width: 100%;"/></a> <br><br><br><hr><br><br><br></p><p><strong>Yeah, it doesn't hurt now!</strong>  <br /> On authorizarion-listener side (yellow) following webservices: <code>&#91;:authorization-server, :reset-password, :signup-form :login :logout&#93;</code> </p><p>On http-listener side (orange) following ones: <code>&#91;:bootstrap-cover-website-website :webapp-oauth-client&#93;</code> </p><h3><a name="todo:&#95;full&#95;doc&#95;in&#95;progress"></a>TODO: full doc In progress</h3>Keep working here in analyzing the no obvious components (oauth2 roles related) :authorization-server and :webapp-oauth-client
    </div>
    
    <div id="tags">
        <b>Tags: </b>
        
        <a href="/tags/oauth2.html">oauth2</a>
        
        <a href="/tags/cylon.html">cylon</a>
        
    </div>
    

    <div id="prev-next">
        
        
        
        <a href="/posts/15-12-2014-milesian-aop.html">Apply AOP in stuartsierra/component &raquo;</a>
        
    </div>

    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//tangrammer.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    


</div>

                </div>
            </div>
        </div>

        <footer>
          <p align="center">
	    <img src="https://g.twimg.com/Twitter_logo_blue.png" width="16">
            <a href="http://twitter.com/tangrammer/">twitter.com/tangrammer</a>
	    |
	    <img src="https://raw.github.com/github/media/master/octocats/blacktocat-16.png">
            <a href="http://github.com/tangrammer/">github.com/tangrammer</a>
	    |
	    <a href="/feed.xml">Atom Feed</a>
          </p>
Copyright &copy; 2014 Juan A. Ruz
            <p style="text-align: center;">Site generator powered by <a href="https://github.com/lacarmen/cryogen">Cryogen</a></p></footer>
    </div>
        <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
        <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
        <script src="../js/highlight.pack.js" type="text/javascript"></script>
        <script>hljs.initHighlightingOnLoad();</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-57767027-1', 'auto');
  ga('send', 'pageview');

</script>
    </body>
</html>
